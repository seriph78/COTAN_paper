---
title: "Negative dataset analysis"
output:
  html_notebook:
      css: html-md-01.css
      fig_caption: yes
      highlight: haddock
      number_sections: yes
      theme: spacelab
      toc: yes
      toc_float: true
      collapsed: no
---
```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  echo = TRUE,
  warning = FALSE,
  tidy = TRUE, tidy.opts=list(width.cutoff=40)
)
options(rmarkdown.html_vignette.check_title = FALSE)
```


```{r }
library(ggplot2)
library(ggrepel)
library(COTAN)
library(patchwork)

p_value_plot <-function(p_values, obj){
    p_values[lower.tri(p_values,diag=TRUE)] <- NA

    p_values2 = as.data.frame(as.table(as.matrix(p_values))) 
    
    if(nrow(p_values2) > 10000){
      p_values2 = p_values2[sample(nrow(p_values2), (nrow(p_values2)/20)) , ]
    }
    p_values2 = p_values2[complete.cases(p_values2),]
    p_values2 = p_values2[order(p_values2$Freq, decreasing = F),]
    p_values2$n = c(1:nrow(p_values2))/nrow(p_values2)
    
    p_values = get.pval(obj,type_stat = "G")
    p_values[lower.tri(p_values,diag=TRUE)] <- NA
    
    p_values3 = as.data.frame(as.table(as.matrix(p_values))) 
    if(nrow(p_values3) > 10000){
      p_values3 = p_values3[sample(nrow(p_values3), (nrow(p_values3)/20)),]
    }
    
    p_values3 = p_values3[complete.cases(p_values3),]
    p_values3 = p_values3[order(p_values3$Freq, decreasing = F),]
    p_values3$n = c(1:nrow(p_values3))/nrow(p_values3)
    print(dim(p_values2))
    print(dim(p_values3))
    
    p_values2$Type = "Chi-squared test"
    p_values3$Type = "G-test"
    
    p_values = rbind(p_values2,p_values3)
    
    plot_p = ggplot(p_values, aes(x = Freq, y = n,colour = Type)) +
      theme(axis.text.x = element_text(size = 12, angle = 0, hjust = .5, vjust = .5, face = "plain"),
            axis.text.y = element_text( size = 12, angle = 0, hjust = 0, vjust = .5, face = "plain"),  
            axis.title.x = element_text( size = 12, angle = 0, hjust = .5, vjust = 0, face = "plain"),
            axis.title.y = element_text( size = 12, angle = 90, hjust = .5, vjust = .5, face = "plain")) + 
      labs(x = "p-value", y = "percentile" ) +
      geom_line(size = 1.5) 
    return(plot_p)
}

plot.GDI.density <- function(GDI.df){
  si=11
  mycolours <- c("Constitutive" = "#00A087FF","dif"="#E64B35FF","normal" = "#8491B4B2")
        themex= theme(axis.text.x = 
                        element_text( size = si, angle = 90, hjust = .5, vjust = .5, face = "plain", 
                                      colour ="#3C5488FF"),
                    axis.text.y = element_blank(),  
                    axis.title.x = element_blank(),
                    axis.title.y = 
                      element_text( size = si, angle = 90, hjust = .5, vjust = .5, face = "plain", 
                                    colour ="#3C5488FF"),
                    legend.position = "none") 
      
      themey = theme(axis.text.y = 
                       element_text( size = si, angle = 0, hjust = .5, vjust = .5, face = "plain", 
                                     colour ="#3C5488FF"),
                     axis.title.x = 
                       element_text( size = si, angle = 0, hjust = .5, vjust = .5, face = "plain", 
                                     colour ="#3C5488FF"),
                     axis.text.x.bottom = element_blank(),
                     axis.title.y = element_blank(),
                     legend.position = "none") 

  
      f1 = ggplot(GDI.df, aes(x=sum.raw.norm, y=GDI)) +  geom_point(alpha = 0.4, color = "#8491B4B2", size=2.5)
      
      
      GDI.df_lin = f1 + 
        geom_hline(yintercept=1.5, linetype="dotted", color = "red", size= 1) +
        scale_color_manual("Status", values = mycolours)  +
        scale_fill_manual("Status", values = mycolours)  +
        xlab("log normalized counts")+ylab("GDI")+
        theme(axis.text.x = 
                element_text(size = si, angle = 0, hjust = .5, vjust = .5, face = "plain", colour ="#3C5488FF" ),
              axis.text.y = 
                element_text( size = si, angle = 0, hjust = 0, vjust = .5, face = "plain", colour ="#3C5488FF"),  
              axis.title.x = 
                element_text( size = si, angle = 0, hjust = .5, vjust = 0, face = "plain", colour ="#3C5488FF"),
              axis.title.y = 
                element_text( size = si, angle = 90, hjust = .5, vjust = .5, face = "plain", colour ="#3C5488FF"),
              legend.title = element_blank(),
              legend.text = element_text(color = "#3C5488FF",face ="italic" ),
              legend.position = "none") 
      
        xdensityGDI.df <- ggplot(GDI.df, aes(sum.raw.norm)) + 
          geom_density(alpha=.5, fill = "#8491B4B2", colour ="#8491B4B2" ) +
          themex  
      
        ydensityGDI.df <- ggplot(GDI.df, aes(GDI)) + 
          geom_density(alpha=.5, fill="#00A087FF", colour= "#00A087FF") + 
          themey +  coord_flip() 
          
      
        GDI.df_lin = xdensityGDI.df + plot_spacer() + GDI.df_lin+ ydensityGDI.df + 
          plot_layout(ncol = 2, nrow = 2, widths = c(4, 1), heights = c(1, 4))
        return(GDI.df_lin)
}
```

# Technical negative dataset: ERCC 10x
```{r echo=TRUE}
ERCC = readRDS("Data/negative_datasets/ERCC.cotan.RDS")
```
```{r echo=TRUE}
p_values_ERCC = get.pval(ERCC)

Plot_ERCC = p_value_plot(p_values_ERCC, ERCC)

Plot_ERCC
```
```{r}
pdf("ERCC_p_value_S_G_plot.pdf")
Plot_ERCC
dev.off()
```


GDI plot with density

```{r}
GDI_ercc = get.GDI(ERCC)

plot.GDI.density(GDI_ercc)
```


# Biological negative dataset: CD14+
```{r echo=TRUE}
CD14 = readRDS("Data/negative_datasets/CD14.cotan.RDS")
```
```{r echo=TRUE}
p_values_CD14 = get.pval(CD14)

Plot_CD14 = p_value_plot(p_values_CD14,obj = CD14)

Plot_CD14
```
```{r}
pdf("CD14_p_value_S_G_plot.pdf")
Plot_CD14
dev.off()
```


GDI plot with density

```{r}
GDI_CD14 = get.GDI(CD14)

plot.GDI.density(GDI_CD14)
```
```{r}
genes = list("genes"=rownames(GDI_CD14[GDI_CD14$GDI>1.5 & GDI_CD14$sum.raw.norm > 5 & GDI_CD14$exp.cells > 2.5,]))
plot.heatmap(df_genes = genes,sets = 1,conditions = "CD14",dir = "Data/negative_datasets/")
```





# Syntetic negative dataset: 4000 cells
```{r }
CE4000 = readRDS("Data/negative_datasets/SymE17_1cl_4000cs.cotan.RDS")
```
```{r }
p_values_CE4000 = get.pval(CE4000)

Plot_CE4000 = p_value_plot(p_values_CE4000, obj = CE4000)

Plot_CE4000

```
```{r}
pdf("CE4000_p_value_S_G_plot.pdf")
Plot_CE4000
dev.off()
```

```{r}
GDI_CE4000 = get.GDI(CE4000)

plot.GDI.density(GDI_CE4000)
```


# Syntetic negative dataset: 800 cells
```{r echo=TRUE}
CE800 = readRDS("Data/negative_datasets/SymE17_1cl_800cs.cotan.RDS")
```
```{r echo=TRUE}
p_values_CE800 = get.pval(CE800)

Plot_CE800 = p_value_plot(p_values_CE800, obj = CE800)

Plot_CE800
```
```{r}
pdf("CE800_p_value_S_G_plot.pdf")
Plot_CE800
dev.off()
```


```{r}
sessionInfo()
```


